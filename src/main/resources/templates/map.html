<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script
            src="https://kit.fontawesome.com/7e5c972fe1.js"
            crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <title>Mapa</title>
    <style>
        body {
          display: flex;
          margin: 0;
          height: 100vh;
          overflow: hidden;
        }

        #map {
          flex: 1;
          height: 100%;
          margin: 0;
        }

        #sidebar-driver,
        #sidebar-truck,
        #sidebar-road {
          position: fixed;
          right: -300px;
          top: 0;
          height: 100%;
          width: 300px;
          background-color: #f9f9f9;
          border-left: 1px solid #ddd;
          overflow-y: auto;
          padding: 15px;
          box-sizing: border-box;
          transition: right 0.3s ease;
          z-index: 1000;
        }

        #sidebar-truck.open,
        #sidebar-driver.open,
        #sidebar-road.open {
          right: 0;
        }

        #sidebar-driver h2,
        #sidebar-truck h2,
        #sidebar-road h2 {
          font-size: 18px;
          margin-bottom: 10px;
        }

        .driver,
        .truck,
        .road {
          border: 1px solid #ddd;
          border-radius: 5px;
          padding: 10px;
          margin-bottom: 10px;
          background-color: #fff;
        }

        .driver h3 {
          margin: 0 0 5px;
          font-size: 16px;
        }

        .driver p {
          margin: 5px 0;
          font-size: 14px;
        }

        #toggle-sidebar-driver-btn  {
          position: fixed;
          right: 10px;
          top: 10px;
          background-color: #007bff;
          color: #fff;
          border: none;
          border-radius: 50%;
          width: 50px;
          height: 50px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          z-index: 1001;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #toggle-sidebar-truck-btn {
          position: fixed;
          right: 10px;
          top: 100px;
          background-color: #007bff;
          color: #fff;
          border: none;
          border-radius: 50%;
          width: 50px;
          height: 50px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          z-index: 1001;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #toggle-sidebar-road-btn {
          position: fixed;
          right: 10px;
          top: 200px;
          background-color: #007bff;
          color: #fff;
          border: none;
          border-radius: 50%;
          width: 50px;
          height: 50px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          z-index: 1001;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #toggle-sidebar-driver-btn i,
        #toggle-sidebar-truck-btn i {
          font-size: 24px;
        }

        #create-driver-form,
        #create-truck-form,
        #create-road-form{
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
          z-index: 1002;
          display: none;
        }

        #create-driver-form input,
        #create-truck-form input,
        #create-road-form input {
          display: block;
          width: 100%;
          margin-bottom: 10px;
          padding: 8px;
          border: 1px solid #ccc;
          border-radius: 4px;
          box-sizing: border-box;
        }

        #create-driver-form button,
        #create-truck-form button,
        #create-road-form button {
          background-color: #007bff;
          color: white;
          border: none;
          padding: 10px 15px;
          border-radius: 4px;
          cursor: pointer;
        }

        #create-driver-form button.close,
        #create-truck-form button.close,
        #create-road-form button.close {
          background-color: #ddd;
          color: black;
          float: right;
        }
    </style>
</head>
<body>
<div id="map"></div>
<div id="sidebar-driver">
    <h2>Lista kierowców</h2>
    <div id="driver-list"></div>
</div>
<div id="sidebar-truck">
    <h2>Lista pojazdów</h2>
    <div id="truck-list"></div>
</div>
<div id="sidebar-road">
    <h2>Lista tras</h2>
    <div id="road-list"></div>
</div>
<button id="toggle-sidebar-driver-btn">
    <i class="fa-solid fa-user"></i>
</button>
<button id="toggle-sidebar-truck-btn">
    <i class="fa-solid fa-truck"></i>
</button>
<button id="toggle-sidebar-road-btn">
    <i class="fa-solid fa-road"></i>
</button>

<button
        id="open-create-driver-form"
        style="position: fixed; left: 10px; top: 10px; background-color: #28a745; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1001; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);"
>
    <i class="fa-solid fa-user"> + </i>
</button>

<button
        id="open-create-truck-form"
        style="position: fixed; left: 10px; top: 100px; background-color: #28a745; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1001; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);"
>
    <i class="fa-solid fa-truck"> + </i>
</button>
<button
        id="open-create-road-form"
        style="position: fixed; left: 10px; top: 200px; background-color: #28a745; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1001; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);"
>
    <i class="fa-solid fa-road"> + </i>
</button>
<!-- Formularz do tworzenia kierowcy -->
<div id="create-driver-form">
    <button class="close" id="close-create-driver-form">&times;</button>
    <h2>Dodaj kierowcę</h2>
    <input type="text" id="driver-name" placeholder="Imię" />
    <input type="text" id="driver-lastName" placeholder="Nazwisko" />
    <input type="text" id="driver-number" placeholder="Numer telefonu" />
    <input type="email" id="driver-email" placeholder="Email" />
    <button id="submit-driver">Dodaj</button>
</div>

<div id="create-truck-form">
    <button class="close" id="close-create-truck-form">&times;</button>
    <h2>Dodaj pojazd</h2>
    <input type="text" id="licensePlate" placeholder="Tablica rej." />
    <input type="text" id="capacity" placeholder="Pojemność" />
    <input type="date" id="inspectionDate" placeholder="Data przeglądu" />
    <button id="submit-truck">Dodaj</button>
</div>

<div id="create-road-form">
    <button class="close" id="close-create-road-form">&times;</button>
    <h2>Dodaj trase</h2>
    <input type="text" id="from" placeholder="Z" />
    <input type="text" id="via" placeholder="Przez" />
    <input type="text" id="to" placeholder="Do" />
    <input type="number" id="roadCapacity" placeholder="Pojemność" />
    <input type="date" id="departureDate" placeholder="Początek" />
    <input type="date" id="arrivalDate" placeholder="Koniec" />
    <button id="submit-road">Dodaj</button>
</div>
<script>

    const map = L.map('map').setView([54, 21.8], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    const handleError = (error, type) => {
      console.error(`Błąd podczas pobierania danych dla ${type}:`, error);
      alert(`Nie udało się załadować danych dla ${type}.`);
    };
    const driverIcon = L.divIcon({
      className: 'icon-large-driver',
      iconSize: [50, 50],
      iconAnchor: [10, 20],
      popupAnchor: [0, -32],
      html: '<i class="fa-solid fa-user"></i>'
    });
    const truckIcon = L.divIcon({
      className: 'icon-large-truck',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32],
      html: ' <i class="fa-solid fa-truck"></i>'
    });

    const sidebarDriver = document.getElementById('sidebar-driver');
    const sidebarTruck = document.getElementById('sidebar-truck');
    const sidebarRoad = document.getElementById('sidebar-road');
    const toggleSidebarDriverBtn = document.getElementById('toggle-sidebar-driver-btn');
    const toggleSidebarTruckBtn = document.getElementById('toggle-sidebar-truck-btn');
    const toggleSidebarRoadBtn = document.getElementById('toggle-sidebar-road-btn');
    const driverListContainer = document.getElementById('driver-list');
    const truckListContainer = document.getElementById('truck-list');
    const roadListContainer = document.getElementById('road-list');

    let driversLoaded = false;
    let trucksLoaded = false;
    let roadsLoaded = false;


    const createDriverForm = document.getElementById('create-driver-form');
    const closeCreateDriverForm = document.getElementById('close-create-driver-form');
    const submitDriverButton = document.getElementById('submit-driver');
    const openCreateDriverFormButton = document.getElementById('open-create-driver-form');

    const createTruckForm = document.getElementById('create-truck-form');
    const closeCreateTruckForm = document.getElementById('close-create-truck-form');
    const submitTruckButton = document.getElementById('submit-truck');
    const openCreateTruckFormButton = document.getElementById('open-create-truck-form');

    const createRoadForm = document.getElementById('create-road-form');
    const closeCreateRoadForm = document.getElementById('close-create-road-form');
    const submitRoadButton = document.getElementById('submit-road');
    const openCreateRoadFormButton = document.getElementById('open-create-road-form');

    const today = new Date().toISOString().split("T")[0];

    document.getElementById("inspectionDate").setAttribute("min", today);
    document.getElementById("departureDate").setAttribute("min", today);
    document.getElementById("arrivalDate").setAttribute("min", today);



    openCreateDriverFormButton.addEventListener('click', () => {
        createDriverForm.style.display = 'block';
    });
    closeCreateDriverForm.addEventListener('click', () => {
        createDriverForm.style.display = 'none';
    });
     openCreateTruckFormButton.addEventListener('click', () => {
        createTruckForm.style.display = 'block';
    });
    closeCreateTruckForm.addEventListener('click', () => {
        createTruckForm.style.display = 'none';
    });
     openCreateRoadFormButton.addEventListener('click', () => {
        createRoadForm.style.display = 'block';
    });
    closeCreateRoadForm.addEventListener('click', () => {
        createRoadForm.style.display = 'none';
    });

    async function reverseGeocode(lat, lon) {
      const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
      const data = await response.json();
      if (data && data.address) {
        return data.address.city || data.address.town || data.address.village || 'Nieznana lokalizacja';
      } else {
        throw new Error('Nie udało się znaleźć nazwy miejscowości');
      }
    }

    function toggleSidebar(sidebar, loadedFlag, endpoint, renderFunction) {
      sidebar.classList.toggle('open');
      if (!loadedFlag.state && sidebar.classList.contains('open')) {
        fetch(endpoint).then(response => response.json()).then(data => {
          renderFunction(data);
          loadedFlag.state = true;
        }).catch(error => console.error(`Błąd przy ładowaniu danych: ${error}`));
      }
    }

    toggleSidebarDriverBtn.addEventListener('click', () => {
      toggleSidebar(sidebarDriver, driversLoaded, '/location/drivers', drivers => {
        driverListContainer.innerHTML = drivers.map(driver => `

          <div class="driver">
              <h3>${driver.name} ${driver.lastName}</h3>
              <p>
                  <strong>Telefon:</strong> ${driver.contactNumber}
              </p>
              <p>
                  <strong>Status:</strong> ${driver.driverStatus}
              </p>
          </div>
                `).join('');
      });
    });

  toggleSidebarTruckBtn.addEventListener('click', () => {
  toggleSidebar(sidebarTruck, trucksLoaded, '/location/trucks', async trucks => {
    const truckDataWithPlaces = await Promise.all(trucks.map(async truck => {
      const place = await reverseGeocode(truck.coordinates.x, truck.coordinates.y);
      return { ...truck, place };
    }));

    truckListContainer.innerHTML = truckDataWithPlaces.map(truck => `
      <div class="truck">
          <h3>${truck.licensePlate}</h3>
          <p><strong>ID:</strong> ${truck.id}</p>
          <p><strong>Status:</strong> ${truck.truckStatus}</p>
          <p><strong>Miejsce:</strong> ${truck.place}</p>
      </div>`).join('');
  });
});

toggleSidebarRoadBtn.addEventListener('click', () => {
      toggleSidebar(sidebarRoad, roadsLoaded, '/location/roads', roads => {
        roadListContainer.innerHTML = roads.map(road => `

          <div class="road">
              <h3> Z: ${road.from} Do: ${road.to} </h3>
              <p>
                  <strong>Przez:</strong> ${road.via}
              </p>
              <p>
                  <strong>Początek:</strong> ${road.departureDate}
              </p>
              <p>
                  <strong>Koniec:</strong> ${road.arrivalDate}
              </p>
               <p>
                  <strong>Status:</strong> ${road.roadStatus}
              </p>
          </div>
                `).join('');
      });
    });
async function fetchData(endpoint, callback) {
try {
const response = await fetch(endpoint);
if (!response.ok) throw new Error(`Błąd HTTP ${response.status}`);
const data = await response.json();
callback(data);
} catch (error) {
console.error(`Błąd przy ładowaniu danych z ${endpoint}:`, error);
}
}


    submitDriverButton.addEventListener('click', () => {
        const name = document.getElementById('driver-name').value;
        const lastName = document.getElementById('driver-lastName').value;
        const contactNumber = document.getElementById('driver-number').value;
        const email = document.getElementById('driver-email').value;

        if (name && lastName && contactNumber && email) {
            const driverData = {
                name: name,
                lastName: lastName,
                email: email,
                contactNumber: contactNumber,
                    };

            fetch('/drivers/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(driverData),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Wystąpił błąd podczas zapisywania kierowcy');
                }
                return response.json();
            })
            .then(data => {
                alert(`Dodano kierowcę: ${data.name} ${data.lastName}`);
                createDriverForm.style.display = 'none';
                // Opcjonalnie: odśwież listę kierowców lub wykonaj inną akcję
            })
            .catch(error => {
                alert(`Błąd: ${error.message}`);
            });
        } else {
            alert('Wypełnij wszystkie pola.');
        }
    });

submitTruckButton.addEventListener('click', () => {
        const licensePlate = document.getElementById('licensePlate').value;
        const capacity = document.getElementById('capacity').value;
        const inspectionDate = document.getElementById('inspectionDate').value;

        if (licensePlate && capacity && inspectionDate) {
            const truckData = {
                licensePlate: licensePlate,
                capacity: capacity,
                inspectionDate: inspectionDate,
                    };

            fetch('/trucks/add', { // Zastąp URL swoim endpointem
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(truckData),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Wystąpił błąd podczas zapisywania pojazdu');
                }
                return response.json();
            })
            .then(data => {
                alert(`Dodano pojazd: ${data.licensePlate}`);
                createTruckForm.style.display = 'none';
                // Opcjonalnie: odśwież listę kierowców lub wykonaj inną akcję
            })
            .catch(error => {
                alert(`Błąd: ${error.message}`);
            });
        } else {
            alert('Wypełnij wszystkie pola.');
        }
    });
submitRoadButton.addEventListener('click', () => {
        const from = document.getElementById('from').value;
        let via = document.getElementById('via').value;
        const to = document.getElementById('to').value;
        const roadCapacity = document.getElementById('roadCapacity').value;
        const departureDate = document.getElementById('departureDate').value;
        const arrivalDate = document.getElementById('arrivalDate').value;

        via = via.split(",").map(v => v.trim()).filter(v => v);

        if (from && via && to && departureDate && arrivalDate && roadCapacity) {
            const roadData = {
                from: from,
                via: via,
                to: to,
                departureDate: departureDate,
                arrivalDate: arrivalDate,
                roadCapacity: roadCapacity,
                    };

            fetch(`/roads/add?capacity=${roadCapacity}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(roadData),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Wystąpił błąd podczas zapisywania trasy');
                }
                return response.json();
            })
            .then(data => {
                alert(`Dodano trase: ${data.from} - ${data.to}`);
                createRoadForm.style.display = 'none';
                // Opcjonalnie: odśwież listę kierowców lub wykonaj inną akcję
            })
            .catch(error => {
                alert(`Błąd: ${error.message}`);
            });
        } else {
            alert('Wypełnij wszystkie pola.');
        }
    });


   function addMarkers(items, icon, popupTemplate) {
    items.forEach(item => {
        if (!item.coordinates || typeof item.coordinates.x === "undefined" || typeof item.coordinates.y === "undefined") {
            console.error("Błąd: brak współrzędnych w elemencie", item);
            return;
        }

        const marker = L.marker([item.coordinates.x, item.coordinates.y], { icon })
            .addTo(map)
            .bindPopup(popupTemplate(item));
    });
}

    fetchData('/drivers/get/all', drivers => {
addMarkers(drivers, driverIcon, driver => `
<h3>${driver.name} ${driver.lastName}</h3>
<p><strong>Numer telefonu:</strong> ${driver.contactNumber}</p>
<p><strong>Status:</strong> ${driver.driverStatus}</p>
`);
});


    fetchData('/trucks/get/all', trucks => {
      addMarkers(trucks, truckIcon, truck => `
          <h3>${truck.licensePlate}</h3>
          <p><strong>ID:</strong> ${truck.id}</p>
          <p><strong>Status:</strong> ${truck.truckStatus}</p>
          `);
    });



    async function geocodeCity(city) {
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`);
      const data = await response.json();
      if (data.length > 0) {
        return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      } else {
        throw new Error(`Nie znaleziono współrzędnych dla miasta: ${city}`);
      }
    }
    async function geocodeCities(cities) {
      const coordinates = [];
      for (const city of cities) {
        try {
          const coords = await geocodeCity(city);
          coordinates.push(coords);
        } catch (error) {
          console.error(error);
        }
      }
      return coordinates;
    }
    async function getRouteFromOSRM(startCoords, endCoords) {
      const routeUrl = `https://router.project-osrm.org/route/v1/driving/${startCoords[1]},${startCoords[0]};${endCoords[1]},${endCoords[0]}?overview=full&geometries=geojson`;
      const response = await fetch(routeUrl);
      if (!response.ok) {
        throw new Error(`Błąd podczas pobierania trasy: ${response.status}`);
      }
      const data = await response.json();
      if (data.routes && data.routes[0] && data.routes[0].geometry) {
        const distance = data.routes[0].distance;
        const routeCoordinates = data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
        return {
          routeCoordinates,
          distance
        };
      } else {
        throw new Error('Brak dostępnych danych o trasie');
      }
    }

    function sendLocation(x, y) {
    const coordinates = { x, y };
    stompClient.send("/app/location", {}, JSON.stringify(coordinates));
}
var driverMarkers = L.layerGroup().addTo(map);
var drivers = {};

stompClient.connect({}, function () {
stompClient.subscribe('/topic/locations', function (message) {
  var data = JSON.parse(message.body);
  var { driverId, x, y } = data;

  if (drivers[driverId]) {
      drivers[driverId].setLatLng([x, y]);
  } else {
      drivers[driverId] = L.marker([x, y], { icon: driverIcon })
          .bindPopup(`Driver ID: ${driverId}`)
          .addTo(driverMarkers);
  }
});
});



    const routeColors = ['blue', 'green', 'red', 'purple', 'black', 'orange', 'yellow'];

    function drawRoute(road, coordinates, routeColor) {

      let totalDistance = 0;
      let allCoordinates = [];
      coordinates.forEach((_, i) => {
        if (i < coordinates.length - 1) {
          const startCoords = coordinates[i];
          const endCoords = coordinates[i + 1];
          getRouteFromOSRM(startCoords, endCoords).then(({
            routeCoordinates,
            distance
          }) => {
            allCoordinates = [...allCoordinates, ...routeCoordinates];
            totalDistance += distance;
            const polyline = L.polyline(allCoordinates, {
              color: routeColor,
              weight: 4,
              opacity: 0.7
            }).addTo(map);
            polyline.bindPopup(`

          <strong>RoadID:</strong> ${road.id}
          <br>
              <strong>Trasa:</strong> ${[road.from, ...road.via, road.to].join(' -> ')}
              <br>
                  <strong>Długość:</strong> ${(totalDistance / 1000).toFixed(2)} km
                  <br>
                      <strong>Koszt:</strong> ${((totalDistance / 1000) * 7).toFixed(2)} zł
                      <br>
                    `);
          });
        }
      });

    }
  fetch('/location/roads')
  .then(response => response.json())
  .then(roads => {
    roads.forEach((road, index) => {
      if (road.roadStatus === "IN_PROGRESS") {
        const routeColor = routeColors[index % routeColors.length];
        geocodeCities([road.from, ...road.via, road.to])
          .then(coordinates => drawRoute(road, coordinates, routeColor))
          .catch(error => console.error(`Błąd przy geokodowaniu: ${error}`));
      }
    });
  })
  .catch(error => console.error(`Błąd przy pobieraniu tras: ${error}`));
</script>
</body>
</html>
